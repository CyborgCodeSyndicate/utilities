name: Deploy Library (composite)

inputs:
  version_bump:
    description: 'Version bump type'
    required: false
    default: none
  modules:
    description: 'Comma-separated Maven modules to deploy (optional)'
    required: false
    default: ""
  github_token:
    description: 'GitHub token'
    required: true
  java_version:
    required: false
    default: "17"
    description: Java version
  server_ids:
    required: false
    default: ""
  github_packages_user:
    required: false
  github_packages_token:
    required: false

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v4
      with: { fetch-depth: 0 }

    - name: Compute Maven server lists
      id: maven_vars
      shell: bash
      run: |
        set -euo pipefail
        DEFAULT="github-utilities"
        EXTRAS="${{ inputs.server_ids }}"

        # Build servers list: always include default, add cleaned extras (no dups/empties)
        SERVERS="$DEFAULT"
        if [ -n "$EXTRAS" ]; then
          IFS=',' read -ra ARR <<< "$EXTRAS"
          for raw in "${ARR[@]}"; do
            id="$(echo "$raw" | xargs)"
            [ -z "$id" ] && continue
            [ "$id" = "$DEFAULT" ] && continue
            SERVERS="$SERVERS,$id"
          done
        fi

        # Count servers
        IFS=',' read -ra LIST <<< "$SERVERS"
        COUNT=${#LIST[@]}

        # Choose creds (fallback to actor/token if not provided)
        USER="${{ inputs.github_packages_user || github.actor }}"
        PASS="${{ inputs.github_packages_token || github.token }}"

        # Repeat user/pass COUNT times (comma-separated) to match setup-java requirements
        USERLIST="$USER"
        PASSLIST="$PASS"
        for ((i=1;i<COUNT;i++)); do
          USERLIST="$USERLIST,$USER"
          PASSLIST="$PASSLIST,$PASS"
        done

        echo "server_ids=$SERVERS"           >> "$GITHUB_OUTPUT"
        echo "server_usernames=$USERLIST"    >> "$GITHUB_OUTPUT"
        echo "server_passwords=$PASSLIST"    >> "$GITHUB_OUTPUT"    

    - name: Configure Java & Maven
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: ${{ inputs.java_version }}
        cache: maven
        server-id: ${{ steps.maven_vars.outputs.server_ids }}
        server-username: ${{ steps.maven_vars.outputs.server_usernames }}
        server-password: ${{ steps.maven_vars.outputs.server_passwords }}

    # replicate your job-level env (OWNER, REPO, GITHUB_TOKEN)
    - name: Set env
      shell: bash
      run: |
        echo "OWNER=${GITHUB_REPOSITORY%/*}" >> "$GITHUB_ENV"
        echo "REPO=${GITHUB_REPOSITORY#*/}"  >> "$GITHUB_ENV"
        echo "GITHUB_TOKEN=${{ inputs.github_token }}" >> "$GITHUB_ENV"

    - name: Compute next version
      id: version
      shell: bash
      run: |
        set -euo pipefail

        bump="${{ inputs.version_bump }}"
        branch="${GITHUB_REF#refs/heads/}"

        if [[ "$bump" != "none" && "$branch" != "main" ]]; then
          echo "âŒ '$bump' releases allowed only on main" >&2
          exit 1
        fi

        current=$(mvn -q -Dexpression=project.version -DforceStdout help:evaluate 2>/dev/null || echo "")
        [[ -z "$current" ]] && { echo "Could not determine project.version" >&2; exit 1; }

        base=${current%-SNAPSHOT}
        IFS='.' read -ra parts <<<"$base"
        maj=${parts[0]:-0}; min=${parts[1]:-0}; pat=${parts[2]:-0}

        if [[ "$bump" == "major" ]]; then
          maj=$((maj+1)); min=0; pat=0
        elif [[ "$bump" == "minor" ]]; then
          min=$((min+1)); pat=0
        elif [[ "$bump" == "patch" ]]; then
          pat=$((pat+1))
        else
          sha=$(git rev-parse --short HEAD)
          run_id="${GITHUB_RUN_ID:-}"
          next="${base}-SNAPSHOT-${sha}-${run_id}"
        fi

        [[ -z "${next:-}" ]] && next="${maj}.${min}.${pat}"

        echo "current=$current" >>"$GITHUB_OUTPUT"
        echo "next=$next"       >>"$GITHUB_OUTPUT"
        echo "bump=$bump"       >>"$GITHUB_OUTPUT"
        echo "branch=$branch"   >>"$GITHUB_OUTPUT"

    - name: Set POM version
      shell: bash
      run: >
        mvn -B versions:set
        -DnewVersion=${{ steps.version.outputs.next }}
        -DgenerateBackupPoms=false

    - name: Commit version bump & tag
      if: ${{ steps.version.outputs.bump != 'none' }}
      shell: bash
      env:
        NEXT: ${{ steps.version.outputs.next }}
      run: |
        git config user.name  "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add -A
        git commit -m "chore(release): $NEXT" || echo "Nothing to commit"
        git tag "v$NEXT"
        git push --follow-tags

    - name: Deploy to GitHub Packages
      shell: bash
      run: |
        set -e
        if [[ -n "${{ inputs.modules }}" ]]; then
          modules_flag="-pl \"${{ inputs.modules }}\" -am"
        else
          modules_flag=""
        fi
        
        eval mvn -B $modules_flag -DskipTests \
          -DaltDeploymentRepository=github::default::https://maven.pkg.github.com/${OWNER}/${REPO} \
          deploy

    - name: Deployment summary
      shell: bash
      run: |
        {
          echo "### ðŸ“¦ Deployment Summary"
          echo ""
          echo "| Item | Value |"
          echo "|------|-------|"
          echo "| **Version published** | \`${{ steps.version.outputs.next }}\` |"
          echo "| **Branch** | \`${{ steps.version.outputs.branch }}\` |"
          if [[ "${{ steps.version.outputs.bump }}" == "none" ]]; then
            echo "| **Type** | Snapshot build |"
          else
            echo "| **Type** | Release â€” **${{ steps.version.outputs.bump }}** |"
          fi
        } >> "$GITHUB_STEP_SUMMARY"
