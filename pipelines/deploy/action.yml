name: Deploy Library (Composite)
description: Build and deploy Maven libraries to GitHub Packages

inputs:
  # Version management
  version_bump:
    description: 'Version bump type (major, minor, patch, none)'
    required: false
    default: none

  # Module selection
  modules:
    description: 'Comma-separated Maven modules to deploy (optional)'
    required: false
    default: ""

  # Deployment configuration
  deploy_server_id:
    description: 'Maven server ID for deployment (-DaltDeploymentRepository)'
    required: false
    default: github

  # Authentication
  github_token:
    description: 'GitHub token for Git operations and API access'
    required: true
  github_packages_user:
    description: 'GitHub Packages username (optional, for external dependencies)'
    required: false
  github_packages_token:
    description: 'GitHub Packages token (optional, for external dependencies)'
    required: false

  # Environment
  java_version:
    description: 'Java version to use'
    required: false
    default: "17"
  server_ids:
    description: 'Additional Maven server IDs to configure (comma-separated)'
    required: false
    default: ""

runs:
  using: "composite"
  steps:
    # === INITIALIZATION ===
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for version tagging

    - name: Setup Environment Variables
      shell: bash
      run: |
        echo "OWNER=${GITHUB_REPOSITORY%/*}" >> "$GITHUB_ENV"
        echo "REPO=${GITHUB_REPOSITORY#*/}" >> "$GITHUB_ENV"
        echo "GITHUB_TOKEN=${{ inputs.github_token }}" >> "$GITHUB_ENV"

    # === MAVEN & JAVA SETUP ===
    - name: Setup Maven Environment
      uses: ./pipelines/shared/setup-maven
      with:
        java_version: ${{ inputs.java_version }}
        server_ids: ${{ inputs.server_ids }}
        github_packages_user: ${{ inputs.github_packages_user }}
        github_packages_token: ${{ inputs.github_packages_token }}

    # === VERSION MANAGEMENT ===
    - name: Version Management
      id: version
      uses: ./pipelines/shared/version-management
      with:
        version_bump: ${{ inputs.version_bump }}
        enforce_main_branch: true

    # === GIT OPERATIONS (for releases) ===
    - name: Commit and Tag Release
      if: ${{ steps.version.outputs.is_release == 'true' }}
      shell: bash
      run: |
        set -e
        
        VERSION="${{ steps.version.outputs.next_version }}"
        
        echo "üè∑Ô∏è Creating release commit and tag for version: $VERSION"
        
        # Configure Git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Commit version changes
        git add -A
        if git diff-index --quiet HEAD --; then
          echo "üìù No changes to commit"
        else
          git commit -m "chore(release): $VERSION"
          echo "‚úÖ Created release commit"
        fi
        
        # Create and push tag
        git tag "v$VERSION"
        git push --follow-tags
        
        echo "‚úÖ Pushed release tag: v$VERSION"

    # === DEPLOYMENT ===
    - name: Deploy to GitHub Packages
      shell: bash
      run: |
        set -e
        
        echo "üöÄ Starting deployment to GitHub Packages"
        
        # Build deployment command
        DEPLOY_CMD="mvn -B deploy"
        
        # Add module selection if specified
        if [[ -n "${{ inputs.modules }}" ]]; then
          echo "üì¶ Deploying specific modules: ${{ inputs.modules }}"
          DEPLOY_CMD="$DEPLOY_CMD -pl \"${{ inputs.modules }}\" -am"
        else
          echo "üì¶ Deploying all modules"
        fi
        
        # Configure deployment repository
        DEPLOY_ID="${{ inputs.deploy_server_id }}"
        DEPLOY_URL="https://maven.pkg.github.com/${OWNER}/${REPO}"
        
        echo "üìç Deployment configuration:"
        echo "   Server ID: $DEPLOY_ID"
        echo "   URL: $DEPLOY_URL"
        
        # Execute deployment
        eval $DEPLOY_CMD \
          -DskipTests \
          -DaltDeploymentRepository="${DEPLOY_ID}::default::${DEPLOY_URL}" \
          --no-transfer-progress
        
        echo "‚úÖ Deployment completed successfully"

    # === REPORTING ===
    - name: Generate Deployment Summary
      if: always()
      shell: bash
      run: |
        # Create deployment summary for GitHub Actions
        {
          echo "# üì¶ Deployment Summary"
          echo ""
          echo "## üìä Deployment Details"
          echo ""
          echo "| Property | Value |"
          echo "|----------|-------|"
          echo "| **Version** | \`${{ steps.version.outputs.next_version }}\` |"
          echo "| **Previous Version** | \`${{ steps.version.outputs.current_version }}\` |"
          echo "| **Branch** | \`${{ steps.version.outputs.branch }}\` |"
          echo "| **Bump Type** | \`${{ steps.version.outputs.bump_type }}\` |"
        
          if [[ "${{ steps.version.outputs.is_release }}" == "true" ]]; then
            echo "| **Release Type** | ‚úÖ Production Release |"
            echo "| **Git Tag** | \`v${{ steps.version.outputs.next_version }}\` |"
          else
            echo "| **Release Type** | üì∏ Snapshot Build |"
          fi
        
          if [[ -n "${{ inputs.modules }}" ]]; then
            echo "| **Modules** | \`${{ inputs.modules }}\` |"
          else
            echo "| **Modules** | All modules |"
          fi
        
          echo ""
          echo "## üìç Package Location"
          echo ""
          echo "Packages have been published to:"
          echo "- **Registry**: GitHub Packages"
          echo "- **Repository**: \`${OWNER}/${REPO}\`"
          echo "- **URL**: https://github.com/${OWNER}/${REPO}/packages"
          echo ""
          echo "## üìù Usage"
          echo ""
          echo "To use this version in your Maven project:"
          echo "\`\`\`xml"
          echo "<dependency>"
          echo "  <groupId>com.cyborgcodesyndicate</groupId>"
          echo "  <artifactId>YOUR_ARTIFACT_ID</artifactId>"
          echo "  <version>${{ steps.version.outputs.next_version }}</version>"
          echo "</dependency>"
          echo "\`\`\`"
        } >> "$GITHUB_STEP_SUMMARY"